---
title: "US Flights"
author: "Tim Abram"
date: "May 27, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, cache=T, warning=F, message=F}
# Grab Data for Simple Plots:
year <-c(as.character(1995:2015))
### Data Source: Transtats.bts.gov
for (i in 1:length(year)){
  flights <-read.csv(paste("C:/users/tim/dropbox/bootstrap web design/Data Playground/Datasets/T1000 - Flights/4520972_T_T100D_MARKET_US_CARRIER_ONLY_",year[i], ".csv", sep=""),as.is=T)
flights <-flights[which(flights$CLASS=="F"),]; flights<-flights[,1:6]
if(i == 1){total_flights <- flights}else{
  total_flights <- rbind(total_flights, flights)
}}
```

# Passengers Per Year
Line graph of total passengers over time (how has air travel increased over time?)
```{r, warning=F, message=F}
require(highcharter)
require(reshape2)

total_flights <-total_flights[which(total_flights$PASSENGERS!=0),]

tf2 <- as.data.frame(t(dcast(data = total_flights, .~YEAR, value.var = "PASSENGERS", fun.aggregate = sum)))
tf2$YEAR <-rownames(tf2); colnames(tf2) <-c("PASSENGERS", "YEAR"); tf2<-tf2[-1,]; rownames(tf2)<-NULL
tf2$PASSENGERS <-as.numeric(as.character(tf2$PASSENGERS))

highchart() %>%
  hc_title(text = "Total Flight Passengers Over Time") %>%
  hc_subtitle(text = "Source: BTS.gov") %>%
  #hc_tooltip(valueDecimals=2) %>%
  hc_add_series_labels_values(tf2$YEAR, tf2$PASSENGERS, 
                              type="line") %>%
  hc_tooltip(pointFormat = "{point.y} passengers") %>%
  hc_xAxis(categories = tf2$YEAR) %>%
  hc_legend(enabled=F) %>%
  hc_add_theme(hc_theme_darkunica())

```

# Passengers Per Month (Aggregate by year)
Multi-line graph grouped by year for total passengers for each month (which months are the busiest for air travel?)
```{r, warning=F, message=F}
total_flights$DATE <-as.factor(paste(total_flights$YEAR, "-", total_flights$MONTH, "-1",  sep=""))
tf <-dcast(data = total_flights, MONTH ~ YEAR, value.var = "PASSENGERS", fun.aggregate = sum)

highchart() %>%
  hc_title(text = "Total Flight Passengers Over Time") %>%
  hc_subtitle(text = "Source: BTS.gov") %>%
  #hc_tooltip(valueDecimals=2) %>%
  hc_add_series_labels_values(tf$MONTH,tf$`1995`, name = "1995",
                              type="line") %>%
  hc_add_series_labels_values(tf$MONTH,tf$`1998`, name = "1998",
                              type="line") %>%
  hc_add_series_labels_values(tf$MONTH,tf$`2000`, name = "2000",
                              type="line") %>%
  hc_add_series_labels_values(tf$MONTH,tf$`2002`, name = "2002",
                              type="line") %>%
  hc_add_series_labels_values(tf$MONTH,tf$`2004`, name = "2004",
                              type="line") %>%
  hc_add_series_labels_values(tf$MONTH,tf$`2006`, name = "2006",
                              type="line") %>%
   hc_add_series_labels_values(tf$MONTH,tf$`2015`, name = "2015",
                              type="line") %>%
  hc_tooltip(pointFormat = "{point.y} passengers") %>%
  hc_xAxis(categories = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", 
                          "Aug", "Sep", "Oct", "Nov", "Dec")) %>%
  hc_legend(enabled=T) %>%
  hc_add_theme(hc_theme_darkunica())

```

# Unique Routes over time
Line plot showing the number of unique routes for each year

```{r, warning=F, message=F}
unique_flights <-dcast(data = total_flights, YEAR ~ ORIGIN + DEST, value.var = "PASSENGERS", fun.aggregate = sum)
unique_flights[unique_flights!=0]<-1 #Slow....

ROUTES <-rowSums(unique_flights) -1

highchart() %>%
  hc_title(text = "Unique Flight Routes Over Time") %>%
  hc_subtitle(text = "Source: BTS.gov") %>%
  #hc_tooltip(valueDecimals=2) %>%
  hc_add_series(data=ROUTES, 
                              type="line") %>%
  hc_tooltip(pointFormat = "{point.y} unique routes") %>%
  hc_xAxis(categories = c(as.character(1995:2015))) %>%
  hc_legend(enabled=F) %>%
  hc_add_theme(hc_theme_darkunica())

```

Also: Which route transports the most people? Historically, what were the top-5 most common routes per year and how has this changed in the last 20 years?

```{r, cache=T, warning=F, message=F, fig.height=12}
library(reshape2)
library(gdata)
library(plyr)
library(ggplot2)
library(ggmap)
library(sp)
library(grid)
library(geosphere)
library(maps)
library(cowplot)

for (i in 1:length(year)){
  flights <-read.csv(paste("C:/users/tim/dropbox/bootstrap web design/Data Playground/Datasets/T1000 - Flights/4520972_T_T100D_MARKET_US_CARRIER_ONLY_",year[i], ".csv", sep=""),as.is=T)
flights <-flights[which(flights$CLASS=="F"),]; flights<-flights[,1:6]

#Check if this is necessary....
flights$ORIGIN <-factor(flights$ORIGIN, levels = unique(c(as.character(flights$ORIGIN), as.character(flights$DEST))))
flights$DEST <-factor(flights$DEST, levels = unique(c(as.character(flights$ORIGIN), as.character(flights$DEST))))

flight_routes <-dcast(ORIGIN~DEST, data = flights, value.var ="PASSENGERS", fun.aggregate=sum, drop=F)
rownames(flight_routes)<-flight_routes[,1]
flight_routes <-flight_routes[,-1]
flight_routes<-data.matrix(flight_routes)
flight_routes <-flight_routes + t(flight_routes)

upperTriangle(flight_routes, diag = T)<-0
flight_routes <-melt(flight_routes); colnames(flight_routes)<-c("origin", "dest", "PASSENGERS")
flight_routes <-flight_routes[which(flight_routes$PASSENGERS!=0),]
flight_routes <-flight_routes[order(flight_routes$PASSENGERS, decreasing = T),]

top_routes_a <-flight_routes[1:5,]
top_routes_a$YEAR <-year[i]
if(i == 1){top_routes <-top_routes_a}else{top_routes <-rbind(top_routes, top_routes_a)}
}

### Faceted GGplot-Vis:
airport_geocodes <-read.csv("C:/users/tim/dropbox/bootstrap web design/airport_geocodes.csv", as.is=T)
airport_geocodes <-airport_geocodes[,c("Airport..IATA.", "Latitude", "Longitude")]
airport_geocodes$origin <-airport_geocodes$Airport..IATA.; airport_geocodes$dest <-airport_geocodes$Airport..IATA.

geocode_origin <-join(subset(top_routes, select="origin") , airport_geocodes, by = "origin")
geocode_destination <-join(subset(top_routes, select="dest") , airport_geocodes, by = "dest")
geocode_origin<-geocode_origin[,c(1,3,4)]; geocode_destination<-geocode_destination[,c(1,3,4)]
colnames(geocode_origin)<-c("airport_origin", "lat", "lon")
colnames(geocode_destination)<-c("airport_dest", "lat", "lon")

top_routes$geocode_origin <-subset(geocode_origin, select = c("lon", "lat"))
top_routes$geocode_destination <-subset(geocode_destination, select = c("lon", "lat"))

#Remove NAs (lat/lon reference errors)
top_routes <-top_routes[rowSums(is.na(top_routes[,5:6]))==0,]

# get intermediate points between the two locations
arch_points <-100
arch <- gcIntermediate(top_routes$geocode_origin,
                       top_routes$geocode_destination,
                       n=arch_points,
                       breakAtDateLine=FALSE, 
                       addStartEnd=TRUE, sp=TRUE)

arch_fortified <- ldply(arch@lines, fortify) # http://docs.ggplot2.org/0.9.3.1/fortify.map.html
arch_fortified$total_passengers <- top_routes[rep(row.names(top_routes), rep(arch_points +2, nrow(top_routes))),"PASSENGERS"]

all_states <-map_data("usa")

ggplot() + geom_polygon(data = all_states, aes(x=long, y=lat, group=group, color = NULL), fill="gray70")+
  geom_line(aes(long,lat,group=group, color = total_passengers), data=arch_fortified, alpha=1, size=1) +
  geom_point(aes(geocode_origin$lon, geocode_origin$lat), size=2, data = top_routes, colour = "red")+
  scale_color_gradient(low="blue", high="red")+
  coord_cartesian(ylim =c(22, 52), xlim=c(-130, -65)) + #Focus on US Alone
  theme(axis.title = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.text = element_blank())+guides(color=F)+
  #theme_nothing() + 
  facet_wrap(~YEAR, ncol = 4)
```


```{r, eval=F, warning=F, message=F}
# source the theme_map for ggplot2 - From AirBNB blogpost
theme_map <- function(base_size = 5) {
  require(grid)
  theme_grey(base_size) %+replace%
    theme(
      axis.title      =   element_blank(),
      axis.text       =   element_blank(),
      panel.background    =   element_rect(fill = "gray88", colour=NA),
      panel.grid      =   element_blank(),
      axis.ticks.length   =   unit(0,"cm"),
      panel.margin    =   unit(0,"lines"),
      plot.margin     =   unit(c(0,0,0,0),"lines"),
      complete = TRUE, 
      panel.background = element_rect(fill = "#01001C", colour=NA)
    )
}
```


```{r, eval = F, warning=F, message=F}
year <-c(as.character(1995:2015))

airport_geocodes <-read.csv("C:/users/tim/dropbox/bootstrap web design/airport_geocodes.csv", as.is=T)
airport_geocodes <-airport_geocodes[,c("Airport..IATA.", "Latitude", "Longitude")]
airport_geocodes$origin <-airport_geocodes$Airport..IATA.; airport_geocodes$dest <-airport_geocodes$Airport..IATA.

### Data Source: Transtats.bts.gov
for (i in 1:length(year)){
  flights <-read.csv(paste("C:/users/tim/dropbox/bootstrap web design/Data Playground/Datasets/T1000 - Flights/4520972_T_T100D_MARKET_US_CARRIER_ONLY_",year[i], ".csv", sep=""),as.is=T)
flights <-flights[which(flights$CLASS=="F"),]; flights<-flights[,1:6]

#Check if this is necessary....
flights$ORIGIN <-factor(flights$ORIGIN, levels = unique(c(as.character(flights$ORIGIN), as.character(flights$DEST))))
flights$DEST <-factor(flights$DEST, levels = unique(c(as.character(flights$ORIGIN), as.character(flights$DEST))))

library(reshape2)
flight_routes <-dcast(ORIGIN~DEST, data = flights, value.var ="PASSENGERS", fun.aggregate=sum, drop=F)
rownames(flight_routes)<-flight_routes[,1]
flight_routes <-flight_routes[,-1]
flight_routes<-data.matrix(flight_routes)
flight_routes <-flight_routes + t(flight_routes)

library(gdata)
upperTriangle(flight_routes, diag = T)<-0
flight_routes <-melt(flight_routes); colnames(flight_routes)<-c("origin", "dest", "PASSENGERS")
flight_routes <-flight_routes[which(flight_routes$PASSENGERS!=0),]
flight_routes <-flight_routes[order(flight_routes$PASSENGERS, decreasing = T),]

## Only keep routes that transported at least 1,000 passengers
#trips <-flight_routes[which(flight_routes$PASSENGERS > 1E3),]
trips<-flight_routes
# get geocoordinates of airports
geocode_origin <-join(subset(trips, select="origin") , airport_geocodes, by = "origin")
geocode_destination <-join(subset(trips, select="dest") , airport_geocodes, by = "dest")
geocode_origin<-geocode_origin[,c(1,3,4)]; geocode_destination<-geocode_destination[,c(1,3,4)]
colnames(geocode_origin)<-c("airport_origin", "lat", "lon")
colnames(geocode_destination)<-c("airport_dest", "lat", "lon")

trips$geocode_origin <-subset(geocode_origin, select = c("lon", "lat"))
trips$geocode_destination <-subset(geocode_destination, select = c("lon", "lat"))

#Remove NAs (lat/lon reference errors)
trips <-trips[rowSums(is.na(trips[,4:5]))==0,]

# get intermediate points between the two locations
started <- Sys.time()
arch_points <-50
arch <- gcIntermediate(trips$geocode_origin,
                       trips$geocode_destination,
                       n=arch_points,
                       breakAtDateLine=FALSE, 
                       addStartEnd=TRUE, sp=TRUE)

arch_fortified <- ldply(arch@lines, fortify) # http://docs.ggplot2.org/0.9.3.1/fortify.map.html
arch_fortified$total_passengers <- trips[rep(row.names(trips), rep(arch_points +2, nrow(trips))),"PASSENGERS"]


arch_fortified$discrete_passengers <-cut(arch_fortified$total_passengers, breaks = c(0, 5E5, 1E6, 3E6, 10E6), include.lowest = T, right=F)

finished <- Sys.time()
finished - started


png(paste("C:/users/tim/dropbox/bootstrap web design/Data Playground/Datasets/T1000 - Flights/", 
          year[i], "_Flights.png", sep=""), width = 600, height = 500)


# Plot with ggplot2
print(ggplot() + #geom_polygon(data = all_states, aes(x=long, y=lat, group=group, color = NULL), fill="gray70")+
  geom_line(aes(long,lat,group=group, alpha = discrete_passengers), size = 1.2, data=arch_fortified, colour="skyblue1") +
  #scale_size_discrete(range = c(0.1, 0.5))+
  
  #coord_cartesian(ylim =c(-5, 70), xlim=c(-165, -40)) + #Focus on US Alone
  coord_cartesian(ylim =c(12, 52), xlim=c(-130, -65)) + #Focus on US Alone

  scale_alpha_manual(values = c(0.01, 0.01, 0.05, 0.3))+
  theme_map() + guides(alpha=F) + 
  annotate("text", x = -100, y = 15, label = year[i], color="white", fontface = 2, family="sans", size=10)+
  theme())

dev.off()

}

### Output Aimated GIF
setwd("C:/users/tim/dropbox/bootstrap web design/Data Playground/Datasets/T1000 - Flights/Animation")
my_command <- '"C:\\Program Files\\ImageMagick-7.0.1-Q16\\convert.exe"  -delay 100 -loop 0 *.png Flight_animation.gif'
system(my_command)

```

![](C:\Users\Tim\Dropbox\Bootstrap Web Design\Data Playground\Datasets\T1000 - Flights\Animation/Flight_animation.gif)

...start with the following simple visualizations, then do the map animation
(figure out how to enhance the separation between the different years (scale # passengers accordingly))

(The animation of the png files ended up being more tricky than I hoped. First, make sure that ImageMagick is installed and that its location is added to the PATH. Open the command line and set its directory to the location of the png files)

